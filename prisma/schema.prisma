generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum UserRole {
  ADMIN
  INVESTIGATOR
  REVIEWER
  VIEWER
}

enum InvestigationStatus {
  DRAFT
  IN_PROGRESS
  PENDING_REVIEW
  CLOSED
  REOPENED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum ProblemCategory {
  HUMAN
  PROCESS
  EQUIPMENT
  MATERIAL
  MEASUREMENT
  ENVIRONMENT
}

enum CAPAType {
  CORRECTION
  CORRECTIVE_ACTION
  PREVENTIVE_ACTION
}

enum CAPAPriority {
  LOW
  MEDIUM
  HIGH
}

enum CAPAStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
}

enum EffectivenessResult {
  EFFECTIVE
  NOT_EFFECTIVE
  PENDING
}

enum DetectionMethod {
  DEVIATION
  OOS
  ALARM
  AUDIT
  COMPLAINT
  OTHER
}

enum FishboneCategory {
  MAN
  MACHINE
  METHOD
  MATERIAL
  MEASUREMENT
  ENVIRONMENT
}

enum CauseType {
  COMMON
  SPECIAL
  UNKNOWN
}

enum SuspectedCauses {
  SINGLE
  MULTIPLE
}

// ─── Core Models ─────────────────────────────────────────────────────────────

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole @default(INVESTIGATOR)
  department   String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // AI usage limits
  aiDailyLimit   Int @default(20)
  aiMonthlyLimit Int @default(200)

  // Account lockout
  lockedUntil       DateTime?
  failedLoginCount  Int       @default(0)
  lastFailedLogin   DateTime?

  // Password metadata
  passwordChangedAt DateTime?

  investigations         Investigation[] @relation("InvestigationOwner")
  reviewedInvestigations Investigation[] @relation("InvestigationReviewer")
  capaActions            CAPAAction[]    @relation("CAPAOwner")
  activeSessions         ActiveSession[]
  aiUsageRecords         AIUsageRecord[]

  @@map("users")
}

model Investigation {
  id              String              @id @default(cuid())
  referenceNumber String              @unique
  title           String
  status          InvestigationStatus @default(DRAFT)
  currentStep     Int                 @default(1)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  closedAt        DateTime?

  createdById String
  createdBy   User   @relation("InvestigationOwner", fields: [createdById], references: [id])
  reviewerId  String?
  reviewer    User?  @relation("InvestigationReviewer", fields: [reviewerId], references: [id])

  problemDefinition    ProblemDefinition?
  riskAssessment       RiskAssessment?
  toolDecision         ToolDecision?
  problemCategory      ProblemCategoryRecord?
  fiveWhys             FiveWhysRecord[]
  fishboneCauses       FishboneCause[]
  isIsNotEntries       IsIsNotEntry[]
  processAnalysisSteps ProcessAnalysisStep[]
  rootCause            RootCauseRecord?
  capaActions          CAPAAction[]
  effectivenessRecord  EffectivenessRecord?

  @@index([status])
  @@index([createdById])
  @@index([createdAt])
  @@map("investigations")
}

// ─── Step 2: Problem Definition ──────────────────────────────────────────────

model ProblemDefinition {
  id              String        @id @default(cuid())
  investigationId String        @unique
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  description         String   @db.Text
  department          String
  occurredAt          DateTime
  detectionMethod     DetectionMethod
  detectionDetail     String?  @db.Text
  containmentActions  String   @db.Text
  productAffected     Boolean  @default(false)
  productDetails      String?  @db.Text
  completedAt         DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("problem_definitions")
}

// ─── Step 3: Risk Assessment ─────────────────────────────────────────────────

model RiskAssessment {
  id              String        @id @default(cuid())
  investigationId String        @unique
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  q1Score Int
  q2Score Int
  q3Score Int
  q4Score Int
  q5Score Int

  totalScore Int
  riskLevel  RiskLevel

  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("risk_assessments")
}

// ─── Step 4: Tool Decision ──────────────────────────────────────────────────

model ToolDecision {
  id              String        @id @default(cuid())
  investigationId String        @unique
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  // Tool selection
  fiveWhys        Boolean @default(true)
  fishbone        Boolean @default(false)
  isIsNot         Boolean @default(false)
  processAnalysis Boolean @default(false)
  notes           String? @db.Text

  // 5W2H gap fields
  who         String? @db.Text
  why         String? @db.Text
  howMuch     String? @db.Text
  whereDetail String? @db.Text
  howDetail   String? @db.Text

  // Complexity assessment
  causeType             CauseType?
  isRecurring           Boolean?
  suspectedCauses       SuspectedCauses?
  processChangeInvolved Boolean?
  processChangeDetail   String? @db.Text

  // AI recommendation
  aiRecommendation String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tool_decisions")
}

// ─── Step 5: Problem Category ────────────────────────────────────────────────

model ProblemCategoryRecord {
  id              String          @id @default(cuid())
  investigationId String          @unique
  investigation   Investigation   @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  category      ProblemCategory
  justification String          @db.Text

  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("problem_category_records")
}

// ─── Step 6: 5 Whys ──────────────────────────────────────────────────────────

model FiveWhysRecord {
  id              String        @id @default(cuid())
  investigationId String
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  treeIndex    Int       @default(0)
  depth        Int
  parentId     String?
  parent       FiveWhysRecord?  @relation("WhyTree", fields: [parentId], references: [id], onDelete: Cascade)
  children     FiveWhysRecord[] @relation("WhyTree")

  whyQuestion  String @db.Text
  answer       String @db.Text
  evidence     String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([investigationId])
  @@index([parentId])
  @@map("five_whys_records")
}

// ─── Step 7: Fishbone / Ishikawa ────────────────────────────────────────────

model FishboneCause {
  id              String        @id @default(cuid())
  investigationId String
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  category FishboneCategory
  cause    String           @db.Text
  evidence String?          @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([investigationId])
  @@map("fishbone_causes")
}

// ─── Step 8: Is / Is Not Analysis ───────────────────────────────────────────

model IsIsNotEntry {
  id              String        @id @default(cuid())
  investigationId String
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  dimension        String
  isDescription    String @db.Text
  isNotDescription String @db.Text
  distinction      String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([investigationId])
  @@map("is_is_not_entries")
}

// ─── Step 9: Process Analysis Table ─────────────────────────────────────────

model ProcessAnalysisStep {
  id              String        @id @default(cuid())
  investigationId String
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  stepNumber      Int
  processStep     String  @db.Text
  expected        String  @db.Text
  actual          String  @db.Text
  deviation       Boolean @default(false)
  deviationDetail String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([investigationId])
  @@map("process_analysis_steps")
}

// ─── Step 10: Root Cause ─────────────────────────────────────────────────────────

model RootCauseRecord {
  id              String        @id @default(cuid())
  investigationId String        @unique
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  rootCauseStatement String  @db.Text
  validationQ1       Boolean
  validationQ2       Boolean
  validationQ3       Boolean
  hasWarnings        Boolean @default(false)
  warningAcknowledged Boolean @default(false)

  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("root_cause_records")
}

// ─── Step 11: CAPA Actions ───────────────────────────────────────────────────

model CAPAAction {
  id              String        @id @default(cuid())
  investigationId String
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  type          CAPAType
  description   String      @db.Text
  ownerId       String
  owner         User        @relation("CAPAOwner", fields: [ownerId], references: [id])
  dueDate       DateTime
  priority      CAPAPriority
  successMetric String       @db.Text
  status        CAPAStatus   @default(OPEN)
  completedAt   DateTime?
  completionNotes String?    @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([investigationId])
  @@index([ownerId])
  @@map("capa_actions")
}

// ─── Step 12: Effectiveness Verification ─────────────────────────────────────

model EffectivenessRecord {
  id              String        @id @default(cuid())
  investigationId String        @unique
  investigation   Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  monitoringPeriodDays  Int
  verificationMethod    String              @db.Text
  successCriteria       String              @db.Text
  result                EffectivenessResult @default(PENDING)
  resultDetail          String?             @db.Text
  reviewerApproved      Boolean             @default(false)
  reviewerName          String?
  reviewerNotes         String?             @db.Text
  reviewedAt            DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("effectiveness_records")
}

// ─── Auth Security ──────────────────────────────────────────────────────────

model ActiveSession {
  id            String    @id @default(cuid())
  jti           String    @unique
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userAgent     String?   @db.Text
  ipAddress     String?
  lastActiveAt  DateTime  @default(now())
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  revokedAt     DateTime?
  revokedReason String?

  @@index([userId])
  @@index([expiresAt])
  @@map("active_sessions")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String
  ipAddress String?
  success   Boolean
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@map("login_attempts")
}

// ─── Audit Logging ──────────────────────────────────────────────────────────

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  userEmail  String?
  action     String
  entityType String?
  entityId   String?
  metadata   String?  @db.Text
  ipAddress  String?
  userAgent  String?  @db.Text
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ─── AI Usage Tracking ──────────────────────────────────────────────────────

model AIUsageRecord {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action        String
  model         String
  inputTokens   Int
  outputTokens  Int
  estimatedCost Float
  createdAt     DateTime @default(now())

  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("ai_usage_records")
}
